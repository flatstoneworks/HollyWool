# HollyWool Code Review Report

**Date:** 2026-01-27 21:43 CET
**Reviewed by:** Claude Opus 4.5
**TypeScript typecheck:** PASS (zero errors)
**Total issues found:** 90 (11 HIGH, 46 MEDIUM, 33 LOW)

---

## EXECUTIVE SUMMARY — HIGH SEVERITY (11)

| # | Area | Issue | Files |
|---|------|-------|-------|
| 1 | Backend | **4 near-identical JobManager classes** (~300 lines duplicated across `jobs.py`, `video_jobs.py`, `i2v_jobs.py`, `upscale_jobs.py`) | `backend/app/services/` |
| 2 | Backend | **`_process_job` download/load pattern** copy-pasted across 3 job processors | `jobs.py`, `video_jobs.py`, `i2v_jobs.py` |
| 3 | Backend | **`generate.py` is a 728-line god router** handling image gen, video gen, I2V, upscale, LoRA, system resources | `routers/generate.py` |
| 4 | Frontend | **`sessions.ts` / `video-sessions.ts` near-total duplication** — identical code with type names swapped | `lib/sessions.ts`, `lib/video-sessions.ts` |
| 5 | Frontend | **`AssetDetailPage.tsx` / `VideoAssetDetailPage.tsx` near-total duplication** — identical layout with `<img>` vs `<video>` | `pages/AssetDetail*.tsx` |
| 6 | Frontend | **3 duplicate favorite toggle hooks** across ModelsPage, ModelDetailPage, CivitaiModelDetailPage | `pages/Models*.tsx`, `pages/CivitaiModel*.tsx` |
| 7 | Frontend | **ImagePage.tsx is 1585 lines** — monolithic component handling sessions, selectors, upload, generation, results | `pages/ImagePage.tsx` |
| 8 | Frontend | **VideoPage.tsx is 1339 lines** — same monolithic pattern with doubled polling for T2V and I2V | `pages/VideoPage.tsx` |
| 9 | Cross-cut | **`ModelInfo` schema mismatch** — backend has 5 fields, frontend expects 12 (missing `category`, `tags`, `is_cached`, etc.) | `schemas.py`, `client.ts` |
| 10 | Cross-cut | **Version inconsistency** — `0.1.0` in `main.py` + `package.json`, `1.0.0` in `settings.py` + `SettingsPage.tsx` | 5 locations |
| 11 | Cross-cut | **`install.sh` CUDA 12.0-12.3 bug** — elif chain skips these versions, no PyTorch CUDA index assigned | `install.sh:58` |

---

## BACKEND FINDINGS (38 issues)

### Duplicated Code (9 issues)

- **Job managers** (`jobs.py`, `video_jobs.py`, `i2v_jobs.py`, `upscale_jobs.py`): `_load_jobs`, `_save_jobs`, `_update_job`, `_worker`, `get_job`, `get_jobs_by_session`, singleton pattern — all near-identical across 4 files. **A generic `BaseJobManager[T]` would eliminate ~600 lines.**
- **`_load_source_images` / `_load_reference_images`**: Base64 decode + asset load logic duplicated in `jobs.py:120-147` and `i2v_jobs.py:118-174`
- **`get_output_dir()`**: Identical in `generate.py:93` and `assets.py:71`, plus inline in 6 more places
- **`get_data_dir()`**: Same `Path(__file__).parent.parent.parent.parent / "data"` pattern in 8 locations
- **Config loading**: Independent in `main.py`, `inference.py`, `lora_manager.py`, `upscaler.py`
- **Job listing endpoints**: 4 structurally identical functions in `generate.py:346-727`
- **Resource-check + 507 error**: Duplicated between `create_video_job` and `create_i2v_job`
- **Default parameter resolution**: `if steps is None: steps = config["default_steps"]` repeated across 6 methods

### Complex Methods (6 issues)

- `generate.py` — 728 lines, god router (HIGH)
- `InferenceService.load_model()` — 120 lines with 8-branch if/elif (MEDIUM)
- `_process_job` in `jobs.py` — 70+ lines with nested branches (MEDIUM)
- `generate_video()` — 80+ lines, two separate model-specific code paths (MEDIUM)
- `_discover_fal_models()` — 100+ lines with deep nesting (LOW)
- `get_system_info()` — 100 lines inline in router (LOW)

### Potential Bugs (13 issues)

- **`get_log` returns `None`/200 instead of 404** (`settings.py:196-203`)
- **`_save_jobs` file write race condition** — lock covers serialization but not `json.dump` to disk
- **`load_asset_metadata` swallows all exceptions** silently (`assets.py:77-93`)
- **`delete_asset` only handles `.png`** — videos get orphaned `.mp4` files
- **`tqdm_progress_callback` defined but never used** in `inference.py:161-177`
- **`update_log` imported but never called** in `generate.py:88`
- **LoRA `apply` has identical branches** for local vs HuggingFace (`lora_manager.py:201-213`)
- **CivitaiClient httpx.AsyncClient never closed** — resource leak on shutdown
- **`base_models` parameter is a no-op** in CivitaiClient (`civitai_client.py:84-86`)
- **Inconsistent `get_all_jobs()` encapsulation** — some managers expose it, others don't
- **Mixed `datetime.now()` vs `datetime.utcnow()`** — timestamps in different timezones
- **Reference images never cleaned up** after job completion
- **`torch.cuda.empty_cache()` called unconditionally** including on CPU

### Inconsistencies (8 issues)

- Inconsistent `get_all_jobs()` method existence across job managers
- Inconsistent error handling styles in routers (some try/except, some not)
- Inconsistent response types for delete/action endpoints (untyped dicts)
- `JobStatus` is a plain class, not an Enum
- Mixed `datetime.utcnow()` vs `datetime.now()` (different timezones)
- camelCase session models vs snake_case everywhere else
- `load_asset_metadata` vs `load_video_asset_metadata` inconsistent filtering
- `get_log` returns None instead of 404

### Architecture Issues (7 issues)

- In-memory storage with JSON persistence (every progress update writes to disk)
- Singleton pattern without thread safety
- `_pending_images` lazy init via `getattr` hack
- `InferenceService` tightly coupled to all model types (god object)
- Router importing from another router (`generate.py` imports from `settings.py`)
- No dependency injection (global singletons instead of `Depends()`)
- API keys stored in plain JSON file

---

## FRONTEND FINDINGS (26 issues)

### Duplicated Code (13 issues)

- **`sessions.ts` / `video-sessions.ts`** — near-total file duplication (HIGH)
- **`AssetDetailPage` / `VideoAssetDetailPage`** — copy-paste with img/video swap (HIGH)
- **3 favorite toggle hooks** — `useFavorites`, `useFavorite`, `useCivitaiFavorite` (HIGH)
- **`handleDownload`** — same fetch+blob+anchor pattern in 4 files (MEDIUM)
- **`fileToBase64`** — identical in ImagePage and VideoPage (MEDIUM)
- **Resizable sidebar** — mouse event handlers in 3 pages (MEDIUM)
- **Click-outside detection** — identical `useEffect` in ImagePage and VideoPage (MEDIUM)
- **Session sidebar UI** — ~150 lines duplicated between ImagePage and VideoPage (MEDIUM)
- **Image/Video lightbox** — two ~130-line blocks in AssetsPage (MEDIUM)
- **Keyboard navigation** — two `useEffect` blocks for lightbox in AssetsPage (LOW)
- **`formatTimeAgo`** — two different implementations (LOW)
- **`getCategoryIcon/Label`** — duplicated in ModelsPage and ModelDetailPage (LOW)
- **`formatCount/Speed`** — duplicated in ModelsPage and CivitaiModelDetailPage (LOW)

### Complexity (6 issues)

- **ImagePage.tsx** — 1585 lines, needs decomposition into ~7 components (HIGH)
- **VideoPage.tsx** — 1339 lines, same problem (HIGH)
- **ModelsPage.tsx** — 1291 lines, better structured but sub-components in same file (MEDIUM)
- **AssetsPage.tsx** — 847 lines, duplicated filter/sort/lightbox logic (MEDIUM)
- **ProviderDetailPage.tsx** — 694 lines (LOW)
- **JobDetailPage.tsx** — 665 lines (LOW)

### Inconsistencies (5 issues)

- **Manual polling vs TanStack Query** — `NotificationsButton` and `JobDetailPage` use `setInterval`+`fetch` instead of `refetchInterval` (HIGH)
- **`useMutation` vs manual `try/catch`** — bypasses global `MutationCache` error handling (MEDIUM)
- **Hardcoded hex colors** — `bg-[#1a1a1a]`, `border-[#333]` in 3 pages break light theme (MEDIUM)
- **URL state management** — mix of `useUrlState` hook and raw `useSearchParams` (LOW)
- **Export style** — mix of `export default function` and `export function` (LOW)

### Architecture (2 issues)

- **`api/client.ts` is 1203 lines** — all types + all methods + utilities in one file (MEDIUM)
- **No shared application-level components** for ResizableSidebar, SessionSidebar, AssetLightbox, ModelSelector, PromptBar (MEDIUM)

---

## CROSS-CUTTING FINDINGS (26 issues)

### API Contract Mismatches (6 issues)

- **`ModelInfo`** — backend has 5 fields, frontend expects 12 (HIGH)
- **`AssetMetadata`** — `file_size`/`file_path` added dynamically but not in Pydantic model, likely silently dropped (MEDIUM)
- **`get_log`** returns `null`/200 instead of 404 (MEDIUM)
- **`HealthResponse`** — backend has `hostname`, frontend type doesn't declare it (LOW)
- **`deleteProvider`** — backend returns `ProviderConfig`, frontend declares `void` (LOW)
- **`CivitaiDownloadJob.file_size_kb`** — float vs number ambiguity (LOW)

### Type Definitions in Wrong Place (5 issues)

- Provider models in `providers.py` instead of `schemas.py` (MEDIUM)
- Settings models in `settings.py` instead of `schemas.py` (MEDIUM)
- Provider presets duplicated between `providers.ts` and `providers.py` (MEDIUM)
- Session models in `assets.py` (LOW)
- Title models in `generate.py` (LOW)

### Build/Config Issues (6 issues)

- **`torch` in `requirements.txt`** may override CUDA install from `install.sh` (MEDIUM)
- **`datetime.utcnow()` deprecated** in Python 3.12+ — 32+ call sites (MEDIUM)
- **`vite.config.ts` `allowedHosts: ['spark.local']`** blocks localhost development (MEDIUM)
- **`realesrgan`/`basicsr`** notoriously hard to pip install (MEDIUM)
- **Unused `puppeteer` devDependency** — 300MB Chromium download (LOW)
- **Untyped health fetch** bypasses TypeScript safety in `main.tsx` (LOW)

### install.sh Issues (5 issues)

- **CUDA 12.0-12.3** gets no index due to elif chain logic bug (HIGH)
- **No Python version validation** — 3.8 would silently fail later (MEDIUM)
- **`2>/dev/null` on npm commands** suppresses all errors (MEDIUM)
- **`grep -P` not portable** to macOS (LOW)
- **No npm availability check** (LOW)

---

## TOP 5 REFACTORING PRIORITIES

1. **Extract `BaseJobManager[T]`** — eliminates ~600 lines of duplicated code across 4 files, fixes the file-write race condition in one place
2. **Decompose ImagePage + VideoPage** — extract SessionSidebar, ModelSelector, PromptBar, BatchResults as shared components; reduces both from 1300-1500 to ~400 lines each
3. **Unify sessions, favorites, asset detail pages** — merge `sessions.ts`/`video-sessions.ts`, merge `AssetDetailPage`/`VideoAssetDetailPage`, extract single `useFavorites` hook
4. **Fix API contracts** — add missing fields to backend `ModelInfo`, move Pydantic models from routers to `schemas.py`, fix `get_log` 404
5. **Fix `install.sh`** — CUDA 12.0-12.3 elif bug, remove `torch` from `requirements.txt`, add Python version check
